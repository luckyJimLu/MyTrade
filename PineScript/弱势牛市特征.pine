//@version=5
indicator("弱势熊市突破识别器 (Weak Bear Breakout Identifier)", shorttitle="WBBear", overlay=true)

// --- 输入参数 (Inputs) ---
len_avg_body = input.int(20, title="平均K线实体长度周期")
swing_low_len = input.int(10, title="前期波段低点周期")
marginal_breakout_ticks = input.int(5, title="微弱突破的Tick数量")
context_range_len = input.int(30, title="交易区间检测周期")

// --- 核心计算 (Core Calculations) ---
// 计算近期平均K线实体大小和真实波幅(ATR)
avg_body_size = ta.ema(math.abs(close - open), len_avg_body)
atr = ta.atr(14)

// 获取前期波段低点
prev_swing_low = ta.lowest(low, swing_low_len)[1]

// --- 规则评估 (Evaluating the Rules) ---
// 我们将评估每一个K线组合。信号会延迟出现，因为它需要确认。
// 我们关注的形态组合是：突破K线 [bar 2] -> 反转K线 [bar 1] -> 当前K线 [bar 0]

// 规则 1 & 12: 突破K线(bar[2])的特征
// 是一根看跌K线，并跌破了前期低点
bool is_bear_breakout_bar = close[2] < open[2] and low[2] < prev_swing_low[2]

// 实体较小或为平均尺寸
float breakout_body_size = open[2] - close[2]
bool is_small_or_avg_body = breakout_body_size <= avg_body_size[2] * 1.2

// 下影线很长
float breakout_lower_wick = close[2] - low[2]
bool has_large_lower_wick = breakout_lower_wick > breakout_body_size * 0.75

// 规则 11 & 13: 突破是微弱的
float breakout_distance = prev_swing_low[2] - low[2]
bool is_marginal_breakout = breakout_distance <= syminfo.mintick * marginal_breakout_ticks
bool scalper_profit_fail = breakout_distance < atr[2] * 0.25 // 突破距离甚至小于ATR的25%，空头难以获利

// 规则 2 & 6: 紧随其后的K线(bar[1])是牛市反转
bool is_bull_reversal_next = close[1] > open[1]
// 是一个牛市反转K线或牛市内包K线
bool is_inside_bar_next = high[1] < high[2] and low[1] > low[2]
bool is_reversal_or_inside = is_bull_reversal_next and (ta.crossunder(open, close) or is_inside_bar_next)
// 收盘价接近其最高点
bool reversal_closes_near_high = (high[1] - close[1]) < (high[1] - low[1]) * 0.25 // 收盘于K线范围的顶部25%
// 实体大小不容忽视
bool reversal_body_is_decent = (close[1] - open[1]) > avg_body_size[1] * 0.7 // 实体至少是平均大小的70%

// 规则 7: 后续K线(bar[1])的高点高于突破K线(bar[2])之前K线(bar[3])的低点
bool negates_micro_gap = high[1] > low[3]

// 规则 3 & 4: 整体背景不利于突破
// 检查市场是否在交易区间内（使用ATR与区间范围进行比较）
float range_high = ta.highest(high, context_range_len)[1]
float range_low = ta.lowest(low, context_range_len)[1]
bool is_in_trading_range = (range_high - range_low) < atr[1] * 5 // 30根K线的范围小于5倍ATR，可能为区间震荡

// --- 组合所有条件 (Combining All Conditions) ---
// 我们寻找一个同时满足多个弱点条件的组合

// 条件1: 必须有一个看跌突破 (在2根K线前)
bool cond1 = is_bear_breakout_bar

// 条件2: 突破K线本身很弱 (小实体, 长下影线, 突破幅度小)
bool cond2 = is_small_or_avg_body and has_large_lower_wick and is_marginal_breakout

// 条件3: 紧接着出现强烈的看涨反转 (在1根K线前)
bool cond3 = is_reversal_or_inside and reversal_closes_near_high and reversal_body_is_decent

// 条件4: 确认性的价格行为 (例如否定了向下的微观缺口)
bool cond4 = negates_micro_gap

// 条件5: 背景环境支持失败 (例如处于震荡市)
bool cond5 = is_in_trading_range

// 最终信号: 当一个弱势突破(cond2)被立即的强势反转(cond3)所否定时，我们发出信号。
// 将背景(cond5)和确认性行为(cond4)作为加分项。
bool weak_bear_breakout_signal = cond1 and cond2 and cond3 and (cond4 or cond5)

// --- 在图表上绘制信号 (Plotting on the Chart) ---
// 在反转K线下方标记信号，因为它确认了弱势突破
plotshape(series=weak_bear_breakout_signal[1], title="弱势熊市突破", location=location.belowbar, color=color.new(color.green, 0), style=shape.triangleup, size=size.normal)

// 添加背景颜色以突出显示
bgcolor(weak_bear_breakout_signal[1] ? color.new(color.green, 85) : na)