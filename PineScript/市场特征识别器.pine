//@version=5
indicator("市场特征识别器 (Market Character Identifier)", shorttitle="MCI", overlay=true)

// --- 通用输入参数 ---
len_avg_body = input.int(20, "平均K线实体长度周期")
len_avg_vol = input.int(20, "平均交易量周期")
swing_len = input.int(10, "波段高低点周期")
context_range_len = input.int(30, "交易区间检测周期")

// --- 基础计算 ---
avg_body_size = ta.ema(math.abs(close - open), len_avg_body)
avg_volume = ta.ema(volume, len_avg_vol)
atr = ta.atr(14)

// 波段高低点
swing_high = ta.highest(high, swing_len)[1]
swing_low = ta.lowest(low, swing_len)[1]

// --- 强弱度量化函数 ---
calc_strength(float body_size, float volume_ratio, float breakout_size, float follow_through) =>
    float strength = 0.0
    
    // 实体强度 (0-25分)
    strength := strength + math.min(25, (body_size / avg_body_size) * 20)
    
    // 成交量强度 (0-25分)
    strength := strength + math.min(25, (volume_ratio - 1) * 10)
    
    // 突破幅度 (0-25分)
    strength := strength + math.min(25, (breakout_size / atr) * 20)
    
    // 后续跟进强度 (0-25分)
    strength := strength + math.min(25, follow_through * 25)
    
    strength

// --- 市场特征识别函数 ---
identify_character() =>
    float bull_strength = 0.0
    float bear_strength = 0.0
    
    // 计算牛市特征
    bool is_bull = close > open
    float bull_body = close - open
    float bull_volume_ratio = volume / avg_volume
    float bull_breakout = high - swing_high
    float bull_follow = close > close[1] ? 1.0 : 0.0
    
    if is_bull
        bull_strength := calc_strength(bull_body, bull_volume_ratio, bull_breakout, bull_follow)
    
    // 计算熊市特征
    bool is_bear = open > close
    float bear_body = open - close
    float bear_volume_ratio = volume / avg_volume
    float bear_breakout = swing_low - low
    float bear_follow = close < close[1] ? 1.0 : 0.0
    
    if is_bear
        bear_strength := calc_strength(bear_body, bear_volume_ratio, bear_breakout, bear_follow)
    
    [bull_strength, bear_strength]

// --- 执行特征识别 ---
[bull_str, bear_str] = identify_character()

// --- 定义市场状态 ---
string market_state = na
color state_color = na

if bull_str > 75 and bull_str > bear_str
    market_state := "强势牛市"
    state_color := color.green
else if bull_str > 25 and bull_str > bear_str
    market_state := "弱势牛市"
    state_color := color.lime
else if bear_str > 75 and bear_str > bull_str
    market_state := "强势熊市"
    state_color := color.red
else if bear_str > 25 and bear_str > bull_str
    market_state := "弱势熊市"
    state_color := color.maroon
else
    market_state := "震荡市"
    state_color := color.gray

// --- 绘制标识 ---
// 在K线顶部显示市场状态
label market_label = label.new(
    bar_index, high, 
    text=market_state + "\n强度: " + str.tostring(math.max(bull_str, bear_str), "#.##"),
    color=state_color,
    style=label.style_label_down,
    textcolor=color.white
    )
label.delete(market_label[1])

// 添加背景颜色
bgcolor(state_color, transp=85)

// --- 绘制强度指示器 ---
plot(bull_str, "牛市强度", color=color.green, style=plot.style_columns, transp=60)
plot(bear_str, "熊市强度", color=color.red, style=plot.style_columns, transp=60)

// --- 添加趋势线 ---
var line trend_line = na
if ta.change(market_state)
    line.delete(trend_line)
    trend_line := line.new(
        bar_index[10], close[10],
        bar_index, close,
        color=state_color,
        width=2
        )