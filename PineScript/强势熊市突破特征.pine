//@version=5
indicator("强劲熊市突破识别器 (Strong Bear Breakout Identifier)", shorttitle="SBBear", overlay=true)

// --- 输入参数 (Inputs) ---
// 用户可以根据自己的偏好调整这些参数
len_avg_body = input.int(20, title="平均K线实体长度周期")
len_avg_vol = input.int(20, title="平均交易量周期")
vol_multiplier = input.float(10.0, title="交易量倍数", minval=1)
ma_len = input.int(50, title="移动平均线周期")
swing_low_len = input.int(10, title="前期波段低点周期")
follow_through_bars = input.int(3, title="后续确认K线数量")
pullback_bars = input.int(2, title="最大回调K线数量")
reversed_bars_count = input.int(10, title="需要反转的K线数量")

// --- 核心计算 (Core Calculations) ---
// 计算近期平均K线实体大小和交易量
avg_body_size = ta.ema(high - low, len_avg_body)
avg_volume = ta.ema(volume, len_avg_vol)

// 获取移动平均线和前期波段低点
ma_value = ta.sma(close, ma_len)
prev_swing_low = ta.lowest(low, swing_low_len)[1]

// --- 突破K线的条件 (Breakout Bar Conditions) ---
// 1. K线是看跌的 (开盘价 > 收盘价)
is_bear_bar = open > close

// 2. 突破K线有一个大的熊市趋势实体
body_size = open - close
is_large_body = body_size > avg_body_size * 1.5 // 实体大于近期平均实体的1.5倍

// 3. 突破K线的影线很小
upper_wick = high - open
lower_wick = close - low
has_small_wicks = upper_wick < body_size * 0.25 and lower_wick < body_size * 0.25 // 影线小于实体的25%

// 4. 交易量激增
is_volume_spike = volume > avg_volume * vol_multiplier

// 5. 突破了多个支撑位
breaks_ma = close < ma_value
breaks_swing_low = close < prev_swing_low

// 6. 突破K线收盘价反转了多个近期的收盘价和最低价
reversed_closes = 0
reversed_lows = 0
for i = 1 to reversed_bars_count
    if close < close[i]
        reversed_closes := reversed_closes + 1
    if low < low[i]
        reversed_lows := reversed_lows + 1
is_reversing_many_bars = reversed_closes >= reversed_bars_count * 0.8 // 收盘价低于过去80%的K线

// --- 后续K线和回调的条件 (Follow-Through & Pullback Conditions) ---
// 7. 后续K线持续看跌
is_strong_follow_through = true
for i = 1 to follow_through_bars
    // 必须是看跌K线，且收盘价在K线中点之下
    if not (open[i] > close[i] and close[i] < (high[i] + low[i]) / 2)
        is_strong_follow_through := false
        break

// 8. 首次回调是温和的 (即没有强烈的看涨反转)
first_pullback_is_weak = true
for i = 1 to follow_through_bars
    // 如果出现一根实体大于平均大小的牛市K线，则认为回调过强
    if close[i] > open[i] and (close[i] - open[i]) > avg_body_size
        first_pullback_is_weak := false
        break

// --- 微观缺口 (Micro Gap) ---
// 9. 出现向下的微观缺口
// 当前看跌K线(bar[1])的后一根K线(bar[0])的高点 < 当前K线的前一根K线(bar[2])的低点
micro_gap_exists = high[0] <= low[2] and is_bear_bar[1]

// --- 组合所有条件 (Combining All Conditions) ---
// 将所有主要条件组合在一起来确定一个“强劲熊市突破”信号
// 我们将这些条件分为“必须”和“加分”项

// 必须条件:
bool breakout_must_haves = is_bear_bar and is_large_body and is_volume_spike and breaks_ma and breaks_swing_low and is_reversing_many_bars

// 加分条件 (越多越好):
int score = 0
if has_small_wicks
    score := score + 1
if is_strong_follow_through
    score := score + 1
if first_pullback_is_weak
    score := score + 1
if micro_gap_exists[1] // 检查突破发生时是否存在微观缺口
    score := score + 1

// 最终确认信号 (Final Confirmation Signal)
// 当必须条件满足，并且至少有两个加分项时，我们标记这个突破
// 注意信号会延迟 follow_through_bars 的根数出现
strong_bear_breakout_signal = breakout_must_haves[follow_through_bars] and score[follow_through_bars] >= 2

// --- 在图表上绘制信号 (Plotting on the Chart) ---
plotshape(series=strong_bear_breakout_signal, title="强劲熊市突破", location=location.abovebar, color=color.new(color.red, 0), style=shape.triangledown, size=size.large)

// 添加背景颜色以突出显示突破区域
bgcolor(strong_bear_breakout_signal ? color.new(color.red, 85) : na)